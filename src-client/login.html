<!DOCTYPE html>
<html lang="en">

    <head>

        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="styles/output.css">
        <title>login</title>

    </head>

    <body>
        
        <!--контент-->
        <main class="contener h-screen w-screen bg-bgpage flex justify-items-center items-center">


            <!--поле для формы и лого-->
            <div class="form flex h-cform w-form mx-auto flex-col">

                <!--лого-->
                <div class="text-white text-center">Name web-program</div>
                <!--поле ошибки-->
                <span id="errors" class="text-white text-center text-2xl"></span>

                <!--форма отправки-->
                <form id="authorization_form" name="login" class="form flex h-cform w-form mx-auto flex-col rounded-xl bg-bgform p-4 mt-6">

                    <!--name-->
                    <label class="text-white ml-6">Имя пользователя</label>
                    <input class="name w-full rounded-xl mt-2" type="text" id="login"  name="username" placeholder="username" />

                    <!--password-->
                    <div class="mt-4"></div>
                    <label class="text-white ml-6">Пароль пользователя</label>
                    <input class="password w-full rounded-xl mt-2" type="password" id="password" name="password"  placeholder="password" />

                    <div class="mt-4"></div>
                    <button class="bg-bgbut w-full mt-4 rounded-xl py-2 text-white">Вход</button>
                
                </form>

            </div>
        
        </main>
        
        <script>

            async function alluser() {
                const res = await fetch(`http://localhost:5000/user/getall`);
                return res.json();
            }

            const form = document.querySelector("#authorization_form"),
            Errors = document.querySelector("#errors");

            async function login(data) {

                const response = await fetch(`http://localhost:5000/auth/login`, {
                    'method': "POST",
                    'headers': {
                        'Content-type': 'application/json',
                    },
                    'body': JSON.stringify(data)
                });

                const res = await response.json();
                if (res.token) {
                    window.sessionStorage.setItem('token', res.token);
                    window.location.href = `home.html`;
                } else {
                    Errors.innerHTML = "Не верный пароль";
                }

            }

            form.addEventListener('submit', async (e) => {
                
                e.preventDefault();

                const users = await alluser();
                console.log(users)

                const username = document.forms['login'].username.value,
                    password = document.forms['login'].password.value;

                console.log(username);
                console.log(password);

                if (!username || !password) {
                    return Errors.innerHTML = "заполните все поля";
                }

                let i = 1;
                for (let user of users) {
                    console.log(i)
                    i++
                    console.log(user.name)
                   
                    if (user.name == username) {
                        const data = {
                            'name': username,
                            'password': password
                        };
                        login(data);
                        window.sessionStorage.setItem('name', username);
                    }
                    else {
                        Errors.innerHTML = "Такого пользователя не существует";
                    }
                   
                }
    
            })

        </script>

    </body>
</html>